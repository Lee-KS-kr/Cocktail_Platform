<!DOCTYPE html>
<html xmlns:th="http://thymeleaf.org"
	  xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
<meta charset="UTF-8">
<title>장바구니</title>
<!--
<link rel="stylesheet" href="../../static/CSS/corporate/reset.css">
<link rel="stylesheet" href="../../static/CSS/corporate/cartList.css">
  -->
<!-- vs code -->
<link rel="stylesheet" th:href="@{/CSS/corporate/reset.css}">
<link rel="stylesheet" th:href="@{/CSS/corporate/cartList.css}">
<!-- thymeleaf -->

<script th:src="@{/jQuery/jquery-3.7.0.js}"></script>
<script>
$(document).ready(function(){
	let storeCode = $('#storeCode').text();
	let orderCode = $('#orderCode').text();
	let menuNum;
	let menuName;
	let price;
	let orderCount;
	
	let pricePerItem;
	
	/**카트 메뉴 삭제*/
	function deleteCart(button){
		menuNum = button.getAttribute("data-menu-num");
		let result = confirm('선택한 메뉴를 삭제하시겠습니까?');
		if(result == true){
			$.ajax({
				url: "deleteCart",
				type: "post",
				data: {menuNum : menuNum},
				success: function(){
					alert('선택하신 메뉴를 삭제하였습니다.');
				},
				error: function(){
					alert('error');
				}
			});
		}
	}
	
	/**주문 수량 증감*/
	function count(type, menuNum, orderCount){
		let currentOrderCount = parseInt($('#orderCount_' + menuNum).text());
		
		//더하기, 빼기
		if(type === 'plus' && currentOrderCount < 11) {
			currentOrderCount = currentOrderCount + 1;  
	  	}else if(type === 'minus' && currentOrderCount > 0) {
	  		currentOrderCount = currentOrderCount - 1;
	  	}else {
			alert('주문 수량을 확인해주세요.');
			return false;
		}
		
		//결과 출력
	    $('#orderCount_' + menuNum).text(currentOrderCount);
		return currentOrderCount;
	}
	
	/**가격 총 합계 계산*/
	function getTotal(){
		let totalPrice = 0;
		
		//각 메뉴마다 가격을 가져와서 totalPrice에 더함
        $('.price-per-item').each(function() {
        	menuNum = $(this).attr('id').split('_')[1]; //menuNum 추출
            pricePerItem = parseInt($('#orderCount_' + menuNum).text()) * parseInt($('#price_' + menuNum).text());
            totalPrice += pricePerItem;
        });

        //totalPrice를 화면에 출력
        $('#totalPrice').text(totalPrice + '원');
    }
	
	//getTotal 함수 호출
    getTotal();


	/**주문하기*/
	function orderMenu(){
		let currentOrderCount = parseInt($('#orderCount_' + menuNum).html());
		let menuNum = $('#menuNum_' + menu.menuNum).text();
		
		let result = confirm('선택한 메뉴를 주문하시겠습니까?');
		let data = {
			storeCode: storeCode,
			orderCode: orderCode,
			menuNum: menuNum,
			menuName: menuName,
			price: price,
			orderCount: currentOrderCount
		}
		
		if(result){
			$.ajax({
				url: "orderMenu",
				type: "post",
				data: data,
				success: function(){
					alert('선택한 메뉴를 주문하였습니다.');
				},
				error: function(e){
					alert(e.statusText);
				}
			});
		}
	}
	
	/**창 닫기*/
	function closeCart(){
		window.close();
	}
	
});

</script>
</head>

<body>
	<div class="container">
	  <div class="header">
		<h1>장바구니</h1>
	  </div>
	  <!-- 필요한 data -->
	  <span id="orderCode" th:text="${orderCode}" style="display:none;"></span>
	  <span id="storeCode" th:text="${storeCode}" style="display:none;"></span>
	  
	  <!-- 카트에 담은 메뉴 출력 -->
	  <div id="cartList">
	  	<table th:each="menu: ${menuList}" th:if="${menuList != null}">
	  		<!-- null일 경우 에러메세지 출력 -->
	  		<tbody th:if="${menuList == null}" th:text="${err}"></tbody>
	  		<!-- null이 아닐 경우 메뉴 출력 -->
	  		<tr>
	  			<td>
	  				<span th:text="${menu.menuName}"></span>
	  				<span id="menuNum_${menuNum}" th:text="${menu.menuNum}" style="display:none;"></span>
  				</td>
	  			<td><button th:onclick="deleteCart(${menu.menuNum})" value="삭제">삭제</button></td>
	  		</tr>
	  		<tr>
	  			<td><a th:onclick="|javascript:count('plus', ${menu.menuNum})|">+</a></td>
	  			<td th:each="cart: ${carts}" th:if="${cart[0] == menu.menuNum}">
	  				<p id="orderCount_${menuNum}"><span th:text="${cart[1]}"></span>개</p>
  				</td>
	  			<td><a th:onclick="|javascript:count('minus', ${menu.menuNum})|">-</a></td>
	  			<td>
	  				<p class="price-per-item" id="price_${menu.menuNum}">
	  				<span th:text="${menu.price}"></span>원
  				</td>
	  		</tr>
	  	</table>
	  	
	  </div>
	  <p class="cart-total">합계: <span id="totalPrice"></span></p>
	  <button class="orderBT" onclick="closeCart()">닫기</button>
	  <button class="orderBT" onclick="orderMenu()">주문하기</button>
	</div>
  </body>
</html>